<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Admin Dashboard - Taste & Go</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Lora:ital,wght@0,400..700;1,400..700&family=Space+Grotesk:wght@300..700&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      :root {
        --primary-color: #FF4A1C;
        --secondary-color: #B2FFA9;
        --tertiary-color: #565656;
        --glass-bg: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
        --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --glass-blur: blur(10px);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Google Sans", system-ui, sans-serif;
        background: var(--tertiary-color);
        height: 100vh;
        overflow: hidden;
      }

      .glass {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border-radius: 16px;
      }

      .admin-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 70px;
        z-index: 1000;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .admin-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--secondary-color);
      }

      .admin-controls {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .admin-btn {
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 25px;
        font-family: "Google Sans", sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .admin-btn:hover {
        background: var(--secondary-color);
        color: var(--tertiary-color);
        transform: translateY(-2px);
      }

      .dashboard-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        height: 100vh;
        gap: 20px;
        padding: 90px 20px 20px;
      }

      .map-panel {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        height: 100%;
      }

      #map {
        width: 100%;
        height: 100%;
        z-index: 0;
      }

      .stats-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .stats-card {
        padding: 25px;
        color: white;
        min-height: 150px;
      }

      .stats-card h3 {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--secondary-color);
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .stat-item:last-child {
        border-bottom: none;
      }

      .stat-label {
        font-weight: 500;
        color: white;
      }

      .stat-value {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--secondary-color);
      }

      .recent-activity {
        max-height: 300px;
        overflow-y: auto;
      }

      .activity-item {
        padding: 12px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        border-left: 4px solid var(--primary-color);
        color: white;
      }

      .activity-item .time {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 5px;
        color: rgba(255, 255, 255, 0.8);
      }

      .activity-item .action {
        font-weight: 600;
        color: white;
      }

      .user-list {
        max-height: 250px;
        overflow-y: auto;
      }

      .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: white;
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-email {
        font-weight: 600;
        font-size: 0.9rem;
        color: white;
      }

      .user-role {
        font-size: 0.8rem;
        opacity: 0.8;
        color: rgba(255, 255, 255, 0.8);
      }

      .user-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .user-status.online {
        background: var(--secondary-color);
        color: var(--tertiary-color);
      }

      .user-status.offline {
        background: rgba(86, 86, 86, 0.3);
        color: var(--tertiary-color);
      }

      #map {
        height: 100%;
        width: 100%;
        border-radius: 16px;
      }

      .map-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .map-control-btn {
        padding: 12px;
        background: var(--glass-bg);
        backdrop-filter: var(--glass-blur);
        border: 1px solid var(--glass-border);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 18px;
      }

      .map-control-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: scale(1.1);
      }
    </style>
  </head>
  <body>
    <header class="admin-header glass">
      <div class="admin-title">
        <img src="./logo.png" alt="Taste & Go" style="height: 40px; width: auto; max-width: 150px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
        <h1 style="display: none; font-size: 1.8rem; font-weight: 700; color: var(--secondary-color);" data-i18n="adminDashboard">Admin Dashboard</h1>
      </div>
      <div class="admin-controls">
        <button class="admin-btn" onclick="refreshData()" data-i18n="refresh">Refresh</button>
        <button class="admin-btn" onclick="window.location.href='/full-stack-web-gis-irem122/index.html'" data-i18n="backToHome">Back to Home</button>
        <button class="admin-btn" onclick="logout()" data-i18n="logout">Logout</button>
      </div>
    </header>

    <div class="dashboard-container">
      <!-- Sol Panel - Harita -->
      <div class="map-panel glass">
        <div id="map"></div>
        <div class="map-controls">
          <button class="map-control-btn" onclick="addPointMode()" data-i18n-title="addPoint" title="Add Point" id="add-point-btn">
            +
          </button>
          <button class="map-control-btn" onclick="deletePointMode()" data-i18n-title="deletePoint" title="Delete Point" id="delete-point-btn">
            x
          </button>
          <button class="map-control-btn" onclick="viewAllPoints()" data-i18n-title="allPoints" title="All Points">
            M
          </button>
        </div>
      </div>

      <!-- Saƒü Panel - ƒ∞statistikler -->
      <div class="stats-panel">
        <!-- Genel ƒ∞statistikler -->
        <div class="stats-card glass">
          <h3 data-i18n="generalStatistics">General Statistics</h3>
          <div class="stat-item">
            <span class="stat-label" data-i18n="totalPoints">Total Points</span>
            <span class="stat-value" id="total-points">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label" data-i18n="activeUsers">Active Users</span>
            <span class="stat-value" id="active-users">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label" data-i18n="dailyVisits">Daily Visits</span>
            <span class="stat-value" id="daily-visits">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label" data-i18n="reports">Reports</span>
            <span class="stat-value" id="total-flags">0</span>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="stats-card glass">
          <h3 data-i18n="recentActivity">Recent Activity</h3>
          <div id="recent-activity" style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto;">
            <p style="opacity: 0.7; font-size: 12px;" data-i18n="noActivityYet">No activity yet</p>
          </div>
        </div>

        <!-- User Reports -->
        <div class="stats-card glass">
          <h3 style="color: #FF4A1C;" data-i18n="userReports">‚ö†Ô∏è User Reports</h3>
          <div id="reports-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto;">
            <p style="opacity: 0.7; font-size: 12px;" data-i18n="noReportsYet">No reports yet</p>
          </div>
        </div>

      </div>
    </div>

    <script>
      // Check admin session
      const adminSession = localStorage.getItem('adminSession');
      const loginTime = localStorage.getItem('adminLoginTime');
      const now = Date.now();
      const sessionDuration = 24 * 60 * 60 * 1000;

      if (adminSession !== 'true' || !loginTime || (now - parseInt(loginTime)) > sessionDuration) {
        localStorage.removeItem('adminSession');
        localStorage.removeItem('adminLoginTime');
        window.location.href = '/full-stack-web-gis-irem122/admin-login.html';
      }

      // Global variables - exposed to window for module access
      window.map = null;
      window.markers = {};
      window.allSuggestions = [];
      let addMode = false;
      let deleteMode = false;
      let previewMarker = null;

      // Global functions for buttons
      function logout() {
        localStorage.removeItem('adminSession');
        localStorage.removeItem('adminLoginTime');
        window.location.href = '/full-stack-web-gis-irem122/admin-login.html';
      }

      function refreshData() {
        location.reload();
      }

      // Toggle Add Point Mode
      function addPointMode() {
        addMode = !addMode;
        deleteMode = false;
        
        const addBtn = document.getElementById('add-point-btn');
        const deleteBtn = document.getElementById('delete-point-btn');
        
        if (addMode) {
          addBtn.style.background = '#B2FFA9';
          addBtn.style.color = '#333';
          deleteBtn.style.background = '';
          deleteBtn.style.color = '';
          document.getElementById('map').style.cursor = 'crosshair';
          showNotification('Click on the map to add a new point');
        } else {
          addBtn.style.background = '';
          addBtn.style.color = '';
          document.getElementById('map').style.cursor = '';
          if (previewMarker) {
            map.removeLayer(previewMarker);
            previewMarker = null;
          }
        }
      }

      // Toggle Delete Point Mode
      function deletePointMode() {
        deleteMode = !deleteMode;
        addMode = false;
        
        const addBtn = document.getElementById('add-point-btn');
        const deleteBtn = document.getElementById('delete-point-btn');
        
        if (deleteMode) {
          deleteBtn.style.background = '#FF4A1C';
          deleteBtn.style.color = 'white';
          addBtn.style.background = '';
          addBtn.style.color = '';
          document.getElementById('map').style.cursor = 'pointer';
          showNotification('Click on a marker to delete it');
        } else {
          deleteBtn.style.background = '';
          deleteBtn.style.color = '';
          document.getElementById('map').style.cursor = '';
        }
      }

      // View All Points - Zoom to fit all markers
      function viewAllPoints() {
        if (Object.keys(markers).length > 0) {
          const group = new L.featureGroup(Object.values(markers));
          map.fitBounds(group.getBounds().pad(0.1));
          showNotification('Showing all points');
        } else {
          showNotification('No points yet');
        }
      }

      // Show notification
      function showNotification(message) {
        // Remove existing notification
        const existing = document.querySelector('.admin-notification');
        if (existing) existing.remove();

        const notification = document.createElement('div');
        notification.className = 'admin-notification';
        notification.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          z-index: 10000;
          font-family: 'Google Sans', sans-serif;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.remove(), 3000);
      }

      // Add activity log
      function addActivity(text) {
        const container = document.getElementById('recent-activity');
        const item = document.createElement('div');
        item.style.cssText = `
          padding: 8px 12px;
          background: rgba(255,255,255,0.1);
          border-radius: 8px;
          font-size: 12px;
          border-left: 3px solid #FF4A1C;
        `;
        const time = new Date().toLocaleTimeString('tr-TR');
        item.innerHTML = '<span style="opacity:0.7">' + time + '</span> - ' + text;
        
        // Remove "No activity" text if exists
        const noActivity = container.querySelector('p');
        if (noActivity) noActivity.remove();
        
        container.insertBefore(item, container.firstChild);
      }
      
      // Make functions global
      window.showNotification = showNotification;
      window.addActivity = addActivity;

      // Initialize map when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, Leaflet:', typeof L);
        
        // Fix Leaflet icon paths
        delete L.Icon.Default.prototype._getIconUrl;
        L.Icon.Default.mergeOptions({
          iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
          iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
        });

        // Create map and store in window
        window.map = L.map('map').setView([39.925533, 32.866287], 6);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '¬© OpenStreetMap'
        }).addTo(window.map);

        console.log('Map initialized!');

        // Map click handler
        window.map.on('click', handleMapClick);

        // Force resize after short delay
        setTimeout(function() {
          window.map.invalidateSize();
        }, 200);

        addActivity('Admin panel initialized');
      });

      // Handle map clicks
      async function handleMapClick(e) {
        const { lat, lng } = e.latlng;

        if (addMode) {
          // Show preview marker
          if (previewMarker) window.map.removeLayer(previewMarker);
          previewMarker = L.marker([lat, lng]).addTo(window.map);

          // Reverse geocoding
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            const city = data.address?.city || data.address?.town || data.address?.village || 'Unknown';
            const country = data.address?.country || 'Unknown';

            showAddPanel(lat, lng, city, country);
          } catch (err) {
            showAddPanel(lat, lng, 'Unknown', 'Unknown');
          }
        } else if (deleteMode) {
          // Find nearest marker - increase radius to 500m
          let nearestId = null;
          let minDist = Infinity;

          console.log('Delete mode click, checking markers:', Object.keys(markers).length);

          Object.entries(markers).forEach(([id, marker]) => {
            const markerLatLng = marker.getLatLng();
            const dist = map.distance([lat, lng], markerLatLng);
            console.log('Marker', id, 'distance:', dist);
            if (dist < 500 && dist < minDist) {
              minDist = dist;
              nearestId = id;
            }
          });

          if (nearestId) {
            console.log('Found nearest marker:', nearestId);
            if (confirm('Are you sure you want to delete this point?')) {
              await window.deletePoint(nearestId);
            }
          } else {
            showNotification('No point found nearby. Click closer to a marker.');
          }
        }
      }

      // Show add panel
      function showAddPanel(lat, lng, city, country) {
        // Remove existing panel
        const existing = document.getElementById('add-panel');
        if (existing) existing.remove();

        const panel = document.createElement('div');
        panel.id = 'add-panel';
        panel.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 24px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          z-index: 10000;
          min-width: 350px;
          font-family: 'Google Sans', sans-serif;
        `;
        panel.innerHTML = `
          <h3 style="margin:0 0 16px;color:#FF4A1C;">Add New Point</h3>
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;">Title *</label>
            <input id="add-title" type="text" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="Place name">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;">Description</label>
            <textarea id="add-desc" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;min-height:60px;" placeholder="Description (optional)"></textarea>
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;">Category</label>
            <select id="add-category" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
              <option value="food">Food & Dining</option>
              <option value="event">Event</option>
              <option value="culture">Culture</option>
              <option value="nature">Nature</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;margin-bottom:4px;font-weight:500;">Best Time</label>
            <select id="add-time" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
              <option value="morning">Morning</option>
              <option value="noon">Noon</option>
              <option value="evening">Evening</option>
              <option value="night">Night</option>
              <option value="anytime">Anytime</option>
            </select>
          </div>
          <div style="margin-bottom:12px;padding:10px;background:#f5f5f5;border-radius:6px;font-size:13px;">
            <strong>Location:</strong> ${city}, ${country}<br>
            <strong>Coordinates:</strong> ${lat.toFixed(5)}, ${lng.toFixed(5)}
          </div>
          <div style="display:flex;gap:10px;">
            <button onclick="savePoint(${lat}, ${lng}, '${city}', '${country}')" style="flex:1;padding:12px;background:#FF4A1C;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Save</button>
            <button onclick="cancelAdd()" style="flex:1;padding:12px;background:#ddd;color:#333;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
          </div>
        `;
        document.body.appendChild(panel);
      }

      // Cancel add
      function cancelAdd() {
        const panel = document.getElementById('add-panel');
        if (panel) panel.remove();
        if (previewMarker) {
          map.removeLayer(previewMarker);
          previewMarker = null;
        }
        addPointMode(); // Toggle off
      }
    </script>

    <script type="module">
      import { getSuggestions, createSuggestion } from './pages/js/firebase-client.js';
      import { ref, remove, getDatabase, onValue, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
      import { getApps } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';

      // Load and display reports
      function loadReports() {
        const app = getApps()[0];
        if (!app) {
          setTimeout(loadReports, 500);
          return;
        }
        
        const db = getDatabase(app);
        const reportsRef = ref(db, 'reports');
        
        onValue(reportsRef, (snapshot) => {
          const container = document.getElementById('reports-list');
          container.innerHTML = '';
          
          if (!snapshot.exists()) {
            container.innerHTML = '<p style="opacity: 0.7; font-size: 12px;">No reports yet</p>';
            document.getElementById('total-flags').textContent = '0';
            return;
          }
          
          const reports = [];
          snapshot.forEach((child) => {
            reports.push({ id: child.key, ...child.val() });
          });
          
          // Sort by date (newest first)
          reports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          
          // Update total flags count
          const pendingCount = reports.filter(r => r.status === 'pending').length;
          document.getElementById('total-flags').textContent = pendingCount;
          
          reports.forEach(report => {
            const reportCard = document.createElement('div');
            reportCard.style.cssText = `
              padding: 12px;
              background: ${report.status === 'pending' ? 'rgba(255, 74, 28, 0.1)' : 'rgba(178, 255, 169, 0.1)'};
              border-radius: 8px;
              border-left: 4px solid ${report.status === 'pending' ? '#FF4A1C' : '#B2FFA9'};
              font-size: 12px;
            `;
            
            const createdDate = new Date(report.createdAt).toLocaleDateString('en-US', {
              month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            
            reportCard.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <strong style="color: #FF4A1C;">üìç ${report.suggestionTitle || 'Unknown'}</strong>
                <span style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: ${report.status === 'pending' ? '#FF4A1C' : '#4CAF50'}; color: white;">
                  ${report.status || 'pending'}
                </span>
              </div>
              <p style="margin: 4px 0; color: #333;"><strong>Reason:</strong> ${report.reason || 'No reason'}</p>
              <p style="margin: 4px 0; color: #666;"><strong>Location:</strong> ${report.suggestionCity || ''}, ${report.suggestionCountry || ''}</p>
              <p style="margin: 4px 0; color: #666;"><strong>Category:</strong> ${report.suggestionCategory || '-'}</p>
              <p style="margin: 4px 0; color: #888;"><strong>Reported by:</strong> ${report.reporterEmail || 'Anonymous'}</p>
              <p style="margin: 4px 0; color: #888;"><strong>Date:</strong> ${createdDate}</p>
              ${report.status === 'pending' ? `
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                  <button onclick="resolveReport('${report.id}', '${report.suggestionId}')" style="flex: 1; padding: 6px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">‚úì Resolve & Delete</button>
                  <button onclick="dismissReport('${report.id}')" style="flex: 1; padding: 6px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">‚úó Dismiss</button>
                </div>
              ` : ''}
            `;
            
            container.appendChild(reportCard);
          });
        });
      }
      
      // Resolve report - delete the reported suggestion
      window.resolveReport = async function(reportId, suggestionId) {
        if (!confirm('This will DELETE the reported point and mark the report as resolved. Continue?')) {
          return;
        }
        
        try {
          const app = getApps()[0];
          const db = getDatabase(app);
          
          // Delete the suggestion
          if (suggestionId) {
            const suggestionRef = ref(db, 'suggestions/' + suggestionId);
            await remove(suggestionRef);
            
            // Remove marker from map
            if (window.markers[suggestionId]) {
              window.map.removeLayer(window.markers[suggestionId]);
              delete window.markers[suggestionId];
            }
          }
          
          // Update report status
          const reportRef = ref(db, 'reports/' + reportId);
          await update(reportRef, { status: 'resolved', resolvedAt: new Date().toISOString() });
          
          window.showNotification('Report resolved and point deleted');
          window.addActivity('Report resolved - point deleted');
        } catch (err) {
          console.error('Error resolving report:', err);
          alert('Error: ' + err.message);
        }
      };
      
      // Dismiss report - mark as reviewed but keep the suggestion
      window.dismissReport = async function(reportId) {
        if (!confirm('This will dismiss the report but keep the point. Continue?')) {
          return;
        }
        
        try {
          const app = getApps()[0];
          const db = getDatabase(app);
          const reportRef = ref(db, 'reports/' + reportId);
          await update(reportRef, { status: 'dismissed', dismissedAt: new Date().toISOString() });
          
          window.showNotification('Report dismissed');
          window.addActivity('Report dismissed');
        } catch (err) {
          console.error('Error dismissing report:', err);
          alert('Error: ' + err.message);
        }
      };

      // Make functions globally available
      window.savePoint = async function(lat, lng, city, country) {
        const title = document.getElementById('add-title').value.trim();
        if (!title) {
          alert('Please enter a title');
          return;
        }

        const data = {
          title: title,
          description: document.getElementById('add-desc').value.trim(),
          category: document.getElementById('add-category').value,
          timeSlot: document.getElementById('add-time').value,
          lat: lat,
          lng: lng,
          city: city,
          country: country
        };

        try {
          await createSuggestion(data);
          window.showNotification('Point added: ' + title);
          window.addActivity('Point added: ' + title);
          
          // Close panel and reset
          cancelAdd();
          
          // Reload markers
          setTimeout(() => location.reload(), 500);
        } catch (err) {
          console.error('Save error:', err);
          alert('Save error: ' + err.message);
        }
      };

      // Delete marker function - available globally
      window.deleteMarker = async function(id, title) {
        if (!confirm('Are you sure you want to delete "' + (title || 'this point') + '"?')) {
          return;
        }
        
        console.log('Deleting marker:', id);
        
        try {
          const app = getApps()[0];
          const db = getDatabase(app);
          const suggestionRef = ref(db, 'suggestions/' + id);
          
          await remove(suggestionRef);
          console.log('Deleted from Firebase');
          
          // Close popup and remove marker
          if (window.markers[id]) {
            window.markers[id].closePopup();
            window.map.removeLayer(window.markers[id]);
            delete window.markers[id];
          }
          
          window.showNotification('Point deleted successfully!');
          window.addActivity('Point deleted: ' + (title || id));
          
          // Update stats
          document.getElementById('total-points').textContent = Object.keys(window.markers).length;
        } catch (err) {
          console.error('Delete error:', err);
          alert('Delete error: ' + err.message);
        }
      };

      // Load markers
      function loadMarkers() {
        if (!window.map) {
          setTimeout(loadMarkers, 200);
          return;
        }

        getSuggestions({}, (suggestions) => {
          console.log('Loaded suggestions:', suggestions.length);
          window.allSuggestions = suggestions;
          
          // Clear existing markers
          Object.values(window.markers).forEach(m => window.map.removeLayer(m));
          window.markers = {};

          suggestions.forEach(s => {
            if (s.lat && s.lng) {
              // Format date
              const createdDate = s.createdAt ? new Date(s.createdAt).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
              }) : 'Unknown date';
              
              // Get creator info
              const createdBy = s.createdBy || 'Unknown user';
              const creatorEmail = s.creatorEmail || createdBy;
              
              const popupContent = document.createElement('div');
              popupContent.style.minWidth = '220px';
              popupContent.innerHTML = `
                <strong style="font-size: 14px;">${s.title || 'Untitled'}</strong><br>
                <p style="margin: 5px 0; color: #666;">${s.description || 'No description'}</p>
                <em style="color: #888;">${s.city || ''}, ${s.country || ''}</em><br>
                <small>Category: ${s.category || '-'} | Time: ${s.timeSlot || '-'}</small>
                <hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">
                <div style="background: #f5f5f5; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                  <small style="color: #666;">
                    <strong>üë§ Added by:</strong> ${creatorEmail}<br>
                    <strong>üìÖ Date:</strong> ${createdDate}
                  </small>
                </div>
              `;
              
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'üóëÔ∏è Delete This Point';
              deleteBtn.style.cssText = `
                width: 100%;
                padding: 8px;
                background: #FF4A1C;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                font-size: 12px;
              `;
              
              // Store id and title for closure
              const markerId = s.id;
              const markerTitle = s.title;
              deleteBtn.addEventListener('click', function() {
                window.deleteMarker(markerId, markerTitle);
              });
              popupContent.appendChild(deleteBtn);
              
              const marker = L.marker([s.lat, s.lng])
                .addTo(window.map)
                .bindPopup(popupContent);
              window.markers[s.id] = marker;
            }
          });
          
          // Update stats
          document.getElementById('total-points').textContent = suggestions.length;
        });
      }

      setTimeout(loadMarkers, 500);
      setTimeout(loadReports, 600);
    </script>
    <script src="./language-switcher.js"></script>
  </body>
</html>